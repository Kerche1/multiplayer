<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate ScreenShare Control PRO v3.5</title>
  <script src="/socket.io/socket.io.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: linear-gradient(135deg, #4fc3f7, #29b6f6);
      --success: linear-gradient(135deg, #66bb6a, #4caf50);
      --danger: linear-gradient(135deg, #ef5350, #f44336);
      --warning: linear-gradient(135deg, #ff9800, #f57c00);
      --dark: #0f0f23;
      --darker: #1a1a2e;
      --card-bg: rgba(40, 40, 60, 0.8);
      --glass: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.1);
      --text: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 50%, #16213e 100%);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
    #mainMenu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
    }

    .logo {
      font-size: 3.5rem;
      font-weight: 700;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 2rem;
      text-align: center;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { filter: drop-shadow(0 0 20px rgba(79, 195, 247, 0.3)); }
      to { filter: drop-shadow(0 0 30px rgba(79, 195, 247, 0.6)); }
    }

    .auth-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      background: var(--glass);
      padding: 0.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    .auth-form {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      padding: 2.5rem;
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      min-width: 400px;
      display: none;
    }

    .auth-form.active {
      display: block;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    .input-field {
      width: 100%;
      padding: 1rem 1.25rem;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #4fc3f7;
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
      background: rgba(20, 20, 40, 1);
    }

    .btn {
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(79, 195, 247, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 3rem;
      max-width: 800px;
      width: 100%;
    }

    .quick-btn {
      padding: 1.5rem;
      border-radius: 16px;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(20px);
    }

    .quick-create { background: var(--primary); color: white; }
    .quick-join { background: var(--success); color: white; }
    .quick-rooms { 
      background: var(--glass); 
      border: 1px solid var(--border);
      color: var(--text);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
    #app {
      display: none;
      height: 100vh;
      position: relative;
    }

    #screen-container {
      flex: 1;
      position: relative;
      background: #000;
      overflow: hidden;
    }

    #screen-canvas, #cursor-canvas, #overlay-canvas, #whiteboard-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: none;
    }

    #cursor-canvas { pointer-events: none; z-index: 25; }
    #overlay-canvas { pointer-events: none; z-index: 20; }
    #whiteboard-canvas { pointer-events: auto; z-index: 15; }

    #sidebar {
      width: 420px;
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(30px);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .section {
      margin: 1.5rem;
      padding: 1.5rem;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      color: #4fc3f7;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .slider-container {
      margin: 1.25rem 0;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.1);
      outline: none;
      appearance: none;
      border: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(79, 195, 247, 0.4);
    }

    .chat-messages {
      height: 280px;
      overflow-y: auto;
      background: rgba(20, 20, 40, 0.5);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      border: 1px solid var(--border);
      scrollbar-width: thin;
    }

    .chat-message {
      margin: 0.75rem 0;
      padding: 1rem;
      background: var(--glass);
      border-radius: 10px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease;
      word-break: break-word;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .user-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      background: var(--glass);
      border-radius: 10px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .user-item:hover {
      background: rgba(79, 195, 247, 0.1);
      transform: translateX(4px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
    }

    .control-panel {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: rgba(0, 0, 0, 0.85);
      padding: 1.5rem;
      border-radius: 16px;
      backdrop-filter: blur(20px);
      z-index: 30;
      min-width: 220px;
      border: 1px solid var(--border);
    }

    .permissions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .permission-btn {
      padding: 0.5rem;
      border: 1px solid var(--border);
      background: var(--glass);
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .permission-btn.active {
      background: var(--success);
      border-color: #4caf50;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: var(--glass);
      border-radius: 10px;
      font-weight: 500;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1200px) {
      #sidebar { width: 100%; height: 35%; }
      #screen-container { height: 65vh; }
    }

    @media (max-width: 768px) {
      .auth-form { min-width: 90vw; margin: 0 1rem; }
      .quick-actions { grid-template-columns: 1fr; }
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 40;
      text-align: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      max-height: 60vh;
      overflow-y: auto;
      padding: 2rem;
      width: 100%;
      max-width: 1200px;
    }

    .room-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(20px);
    }

    .room-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      border-color: #4fc3f7;
    }

    .room-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #4fc3f7;
      margin-bottom: 1rem;
    }

    .room-stats {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      font-size: 0.95rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
  <div id="mainMenu">
    <div class="logo">ScreenShare PRO</div>
    
    <!-- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è -->
    <div class="auth-tabs">
      <button class="tab-btn active" data-tab="login">–í–æ–π—Ç–∏</button>
      <button class="tab-btn" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button class="tab-btn" data-tab="guest">–ì–æ—Å—Ç—å</button>
    </div>

    <div id="loginForm" class="auth-form active">
      <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
      <div class="input-group">
        <input type="text" class="input-field" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
      </div>
      <div class="input-group">
        <input type="password" class="input-field" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
      </div>
      <button class="btn btn-primary" onclick="login()">üöÄ –í–æ–π—Ç–∏</button>
    </div>

    <div id="registerForm" class="auth-form">
      <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
      <div class="input-group">
        <input type="text" class="input-field" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20" required>
      </div>
      <div class="input-group">
        <input type="email" class="input-field" id="regEmail" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
      </div>
      <div class="input-group">
        <input type="password" class="input-field" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" required>
      </div>
      <button class="btn btn-success" onclick="register()">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </div>

    <div id="guestForm" class="auth-form">
      <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem; font-weight: 600;">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</h2>
      <p style="color: var(--text-muted); margin-bottom: 2rem; text-align: center;">
        –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      </p>
      <button class="btn btn-primary" onclick="loginAsGuest()">üëã –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="quick-actions">
      <button class="quick-btn quick-create" onclick="showCreateRoomModal()">
        üñ•Ô∏è –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
      </button>
      <button class="quick-btn quick-join" onclick="showJoinRoomModal()">
        üöÄ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
      </button>
      <button class="quick-btn quick-rooms" onclick="loadPublicRooms()">
        üìã –ü—É–±–ª–∏—á–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
      </button>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç -->
    <div id="publicRooms" style="display: none;">
      <div class="section-title" style="justify-content: center; margin: 2rem 0 1rem;">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</div>
      <div class="rooms-grid" id="roomsGrid"></div>
    </div>
  </div>

  <!-- –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
  <div id="app">
    <!-- –≠–ö–†–ê–ù -->
    <div id="screen-container">
      <canvas id="screen-canvas"></canvas>
      <canvas id="cursor-canvas"></canvas>
      <canvas id="overlay-canvas"></canvas>
      <canvas id="whiteboard-canvas"></canvas>
      
      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <div class="control-panel" id="controlPanel">
        <div style="font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;">üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <span>üîç</span>
          <span id="zoomLevel">100%</span>
          <span>üîé</span>
        </div>
        <div class="zoom-controls" style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button class="btn btn-secondary" onclick="changeZoom(-0.1)" style="padding: 0.5rem; font-size: 0.9rem;">-</button>
          <button class="btn btn-secondary" onclick="changeZoom(0.1)" style="padding: 0.5rem; font-size: 0.9rem;">+</button>
        </div>
        <button class="btn btn-secondary" onclick="toggleCursorLock()" style="margin-bottom: 1rem; font-size: 0.9rem;">
          üñ±Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫—É—Ä—Å–æ—Ä–∞
        </button>
        <div style="font-size: 0.85rem; color: var(--text-muted);">–î–æ—Å–∫–∞</div>
        <button class="btn btn-secondary" onclick="toggleWhiteboard()" style="margin: 0.5rem 0; padding: 0.5rem; font-size: 0.85rem;">
          ‚úèÔ∏è –í–∫–ª/–í—ã–∫–ª
        </button>
      </div>

      <div class="loading" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
        <div style="margin-top: 1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Ä–∞–Ω–∞...</div>
      </div>
    </div>

    <!-- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="sidebar">
      <!-- –°–¢–ê–¢–£–° -->
      <div class="section">
        <div class="section-title">üì° –°—Ç–∞—Ç—É—Å</div>
        <div id="statusBar" class="status-bar" style="padding: 1rem; background: var(--glass); border-radius: 10px; margin-bottom: 1rem;">
          ‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            üë• <span id="userCount">0</span>
          </div>
          <div class="stat-item">
            üñ•Ô∏è <span id="fpsCounter">0</span> FPS
          </div>
          <div class="stat-item">
            üì∫ <span id="pingValue">0</span>ms
          </div>
          <div class="stat-item">
            üíæ <span id="qualityValue">60%</span>
          </div>
        </div>
      </div>

      <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
      <div class="section">
        <div class="section-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ <span id="totalUsers" style="font-size: 0.9rem; opacity: 0.7;">(0)</span></div>
        <div class="user-list" id="userList"></div>
      </div>

      <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
      <div class="section">
        <div class="section-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <div class="input-group">
          <input type="text" class="input-field" id="roomIdInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" maxlength="20">
        </div>
        <div style="display: flex; gap: 0.75rem;">
          <input type="password" class="input-field" id="roomPassword" placeholder="–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)" style="flex: 1;">
          <button class="btn btn-primary" onclick="joinRoom()" style="width: 120px; padding: 1rem 0.75rem;">
            üöÄ –í–æ–π—Ç–∏
          </button>
        </div>
        <button class="btn btn-success" onclick="startScreenShare()" id="shareButton" disabled style="margin-top: 1rem;">
          üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
        </button>
        <button class="btn btn-danger" onclick="leaveRoom()" id="leaveButton" style="display: none; margin-top: 0.75rem;">
          üö™ –í—ã–π—Ç–∏
        </button>
      </div>

      <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
      <div class="section">
        <div class="section-title">üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="slider-container">
          <label>–ö–∞—á–µ—Å—Ç–≤–æ: <span id="qualityDisplay">60%</span></label>
          <input type="range" class="slider" id="qualitySlider" min="0.1" max="1.0" step="0.05" value="0.6">
        </div>
        <div class="slider-container">
          <label>FPS: <span id="fpsDisplay">30</span></label>
          <input type="range" class="slider" id="fpsSlider" min="10" max="60" value="30">
        </div>
        <div style="margin: 1rem 0;">
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" id="showCursors" checked> üëÅÔ∏è –ö—É—Ä—Å–æ—Ä—ã
          </label>
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" id="mouseControl" checked> üñ±Ô∏è –ú—ã—à—å
          </label>
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" id="keyboardControl"> ‚å®Ô∏è –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
          </label>
        </div>
      </div>

      <!-- –ß–ê–¢ -->
      <div class="section">
        <div class="section-title">üí¨ –ß–∞—Ç</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="display: flex; gap: 0.75rem;">
          <input type="text" class="input-field" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
          <button class="btn btn-secondary" onclick="sendChatMessage()" style="width: 60px;">
            üì§
          </button>
        </div>
      </div>

      <!-- –§–ê–ô–õ–´ -->
      <div class="section">
        <div class="section-title">üìé –§–∞–π–ª—ã</div>
        <div id="filesList" style="max-height: 150px; overflow-y: auto;"></div>
        <input type="file" id="fileInput" style="display: none;" multiple>
        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="margin-top: 0.75rem; font-size: 0.9rem;">
          üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã
        </button>
      </div>
    </div>
  </div>

  <script>
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    const socket = io({ auth: { token: localStorage.getItem('token') } });
    const screenCanvas = document.getElementById('screen-canvas');
    const cursorCanvas = document.getElementById('cursor-canvas');
    const overlayCanvas = document.getElementById('overlay-canvas');
    const whiteboardCanvas = document.getElementById('whiteboard-canvas');
    
    const ctxScreen = screenCanvas.getContext('2d');
    const ctxCursor = cursorCanvas.getContext('2d');
    const ctxOverlay = overlayCanvas.getContext('2d');
    const ctxWhiteboard = whiteboardCanvas.getContext('2d');

    let state = {
      token: null,
      userData: null,
      roomId: '',
      isHost: false,
      isConnected: false,
      screenSharing: false,
      zoomLevel: 1.0,
      cursorLocked: false,
      whiteboardActive: false,
      users: [],
      quality: 0.6,
      fps: 30,
      frameCount: 0,
      lastFpsTime: 0,
      screenStream: null,
      videoElement: null,
      currentRoom: null,
      permissions: {}
    };

    let cursors = new Map();
    let chatHistory = [];
    let roomUsers = [];
    let pendingFrames = 0;
    let isDrawing = false;
    let lastDrawPoint = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    document.addEventListener('DOMContentLoaded', () => {
      setupAuthTabs();
      checkAuthToken();
      resizeCanvases();
      setupEventListeners();
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫
      setTimeout(loadPublicRooms, 1000);
    });

    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    async function register() {
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!username || username.length < 3) return showError('–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ');
      if (!password || password.length < 6) return showError('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');

      try {
        showLoading(true);
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        state.token = data.token;
        state.userData = data.user;
        localStorage.setItem('token', state.token);
        socket.auth.token = state.token;
        socket.connect();

        showApp();
        updateStatus(`‚úÖ ${state.userData.username} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`);
      } catch (error) {
        showError(error.message);
      } finally {
        showLoading(false);
      }
    }

    async function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) return showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

      try {
        showLoading(true);
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        state.token = data.token;
        state.userData = data.user;
        localStorage.setItem('token', state.token);
        socket.auth.token = state.token;
        socket.connect();

        showApp();
        updateStatus(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${state.userData.username}!`);
      } catch (error) {
        showError(error.message);
      } finally {
        showLoading(false);
      }
    }

    async function loginAsGuest() {
      try {
        showLoading(true);
        const response = await fetch('/api/auth/guest', { method: 'POST' });
        const data = await response.json();

        state.token = data.token;
        state.userData = data.user;
        localStorage.setItem('token', state.token);
        socket.auth.token = state.token;
        socket.connect();

        showApp();
        updateStatus(`üëã ${state.userData.username}, –≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å`);
      } catch (error) {
        showError(error.message);
      } finally {
        showLoading(false);
      }
    }

    function checkAuthToken() {
      const token = localStorage.getItem('token');
      if (token) {
        state.token = token;
        socket.auth.token = token;
        socket.connect();
        showApp();
      }
    }

    function showApp() {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      requestAnimationFrame(gameLoop);
    }

    // Socket —Å–æ–±—ã—Ç–∏—è
    socket.on('connect', () => {
      state.isConnected = true;
      updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
    });

    socket.on('rooms-list', (rooms) => {
      displayPublicRooms(rooms);
    });

    socket.on('room-joined', (data) => {
      state.currentRoom = data.room;
      state.isHost = data.room.hostId === socket.id;
      state.permissions = data.room.permissions || {};
      
      updateStatus(`‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ ${state.roomId} (${data.room.users.size} —á–µ–ª.)`);
      document.getElementById('userCount').textContent = data.room.users.size;
      document.getElementById('leaveButton').style.display = 'block';
      document.getElementById('shareButton').disabled = false;
      
      roomUsers = Array.from(data.room.users);
      updateUserList();
    });

    socket.on('user-joined', (data) => {
      roomUsers.push(data);
      document.getElementById('userCount').textContent = roomUsers.length;
      updateUserList();
      addSystemMessage(`${data.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
    });

    socket.on('user-left', (data) => {
      roomUsers = roomUsers.filter(u => u.userId !== data.userId);
      document.getElementById('userCount').textContent = roomUsers.length;
      updateUserList();
      addSystemMessage(`${data.username} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
    });

    socket.on('screen-frame', (data) => {
      pendingFrames--;
      document.getElementById('loadingSpinner').style.display = 'none';
      
      const img = new Image();
      img.onload = () => {
        ctxScreen.drawImage(img, 0, 0, screenCanvas.width, screenCanvas.height);
      };
      img.src = data.imageData;
    });

    socket.on('mouse-event', (data) => {
      cursors.set(data.userId, {
        x: data.x * screenCanvas.width,
        y: data.y * screenCanvas.height,
        color: data.color,
        userId: data.userId.slice(-4)
      });
    });

    socket.on('chat-message', (data) => {
      addChatMessage(data);
    });

    socket.on('room-settings-updated', (settings) => {
      document.getElementById('qualitySlider').value = settings.quality || 0.6;
      document.getElementById('fpsSlider').value = settings.framerate || 30;
    });

    socket.on('error', (data) => {
      showError(data.message);
    });

    // –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    function gameLoop(timestamp) {
      updateFPS(timestamp);
      updateCursors();
      renderOverlay();
      if (state.screenSharing) sendScreenFrame();
      requestAnimationFrame(gameLoop);
    }

    function updateFPS(timestamp) {
      state.frameCount++;
      if (timestamp - state.lastFpsTime >= 1000) {
        document.getElementById('fpsCounter').textContent = state.frameCount;
        state.frameCount = 0;
        state.lastFpsTime = timestamp;
      }
    }

    function updateCursors() {
      ctxCursor.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);
      
      if (!document.getElementById('showCursors').checked) return;
      
      cursors.forEach(({ x, y, color, userId }) => {
        // –ö—É—Ä—Å–æ—Ä
        ctxCursor.fillStyle = color;
        ctxCursor.beginPath();
        ctxCursor.arc(x, y, 14, 0, Math.PI * 2);
        ctxCursor.fill();
        
        // –û–±–≤–æ–¥–∫–∞
        ctxCursor.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctxCursor.lineWidth = 2.5;
        ctxCursor.stroke();
        
        // –ò–º—è
        ctxCursor.fillStyle = 'rgba(0, 0, 0, 0.85)';
        ctxCursor.fillRect(x - 35, y - 28, 70, 22);
        ctxCursor.fillStyle = 'white';
        ctxCursor.font = 'bold 12px Inter';
        ctxCursor.textAlign = 'center';
        ctxCursor.textBaseline = 'middle';
        ctxCursor.fillText(userId, x, y - 17);
      });
    }

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–º–Ω–∞—Ç—ã
    function joinRoom() {
      state.roomId = document.getElementById('roomIdInput').value.trim();
      const password = document.getElementById('roomPassword').value;
      
      if (!state.roomId) {
        showError('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }

      updateStatus(`üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${state.roomId}...`);
      socket.emit('join-room', { roomId: state.roomId, password });
    }

    async function startScreenShare() {
      // Toggle –ª–æ–≥–∏–∫–∞
      if (state.screenSharing) {
        if (state.screenStream) {
          state.screenStream.getTracks().forEach(track => track.stop());
        }
        state.screenSharing = false;
        document.getElementById('shareButton').innerHTML = 'üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
        updateStatus('‚èπÔ∏è –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        return;
      }

      try {
        state.screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { 
            width: { ideal: 1920 }, 
            height: { ideal: 1080 },
            frameRate: { ideal: state.fps }
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true
          }
        });

        state.videoElement = document.createElement('video');
        state.videoElement.srcObject = state.screenStream;
        state.videoElement.play();

        state.screenSharing = true;
        document.getElementById('shareButton').innerHTML = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
        updateStatus('üì∫ –¢–†–ê–ù–°–õ–Ø–¶–ò–Ø –ê–ö–¢–ò–í–ù–ê');
        
        sendScreenFrameLoop();
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞: ' + error.message);
      }
    }

    function sendScreenFrameLoop() {
      if (!state.screenSharing || !state.videoElement) return;
      
      ctxScreen.drawImage(state.videoElement, 0, 0, screenCanvas.width, screenCanvas.height);
      
      const quality = parseFloat(document.getElementById('qualitySlider').value);
      const imageData = screenCanvas.toDataURL('image/jpeg', quality);
      
      socket.emit('screen-frame', {
        roomId: state.roomId,
        imageData,
        settings: {
          quality,
          fps: state.fps,
          timestamp: Date.now()
        }
      });
      
      requestAnimationFrame(sendScreenFrameLoop);
    }

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message || !state.isConnected || !state.roomId) return;

      socket.emit('chat-message', {
        roomId: state.roomId,
        message
      });
      input.value = '';
    }

    function leaveRoom() {
      if (state.screenSharing && state.screenStream) {
        state.screenStream.getTracks().forEach(track => track.stop());
      }
      
      socket.emit('leave-room', { roomId: state.roomId });
      state.roomId = '';
      state.isConnected = false;
      state.screenSharing = false;
      
      document.getElementById('statusBar').textContent = 'üö™ –í—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã';
      document.getElementById('leaveButton').style.display = 'none';
      document.getElementById('shareButton').disabled = true;
      document.getElementById('shareButton').innerHTML = 'üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
      
      ctxScreen.clearRect(0, 0, screenCanvas.width, screenCanvas.height);
      cursors.clear();
      chatHistory = [];
      roomUsers = [];
    }

    // UI —É—Ç–∏–ª–∏—Ç—ã
    function updateStatus(message) {
      const statusBar = document.getElementById('statusBar');
      statusBar.textContent = message;
      statusBar.style.color = message.includes('‚úÖ') ? '#4caf50' : 
                              message.includes('‚ùå') ? '#f44336' : 'white';
    }

    function showError(message) {
      const oldStatus = document.getElementById('statusBar').textContent;
      document.getElementById('statusBar').innerHTML = `‚ùå ${message}`;
      setTimeout(() => {
        document.getElementById('statusBar').textContent = oldStatus;
      }, 5000);
    }

    function addChatMessage(msg) {
      chatHistory.push(msg);
      if (chatHistory.length > 100) chatHistory.shift();

      const chat = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.style.borderLeftColor = msg.color;
      
      const roleBadge = msg.role === 'host' ? 'üëë' : 
                       msg.role === 'moderator' ? '‚≠ê' : '';
      
      div.innerHTML = `
        <div style="font-weight: 600; color: ${msg.color}; display: flex; align-items: center; gap: 0.5rem;">
          ${roleBadge}${msg.username.slice(0, 12)}
        </div>
        <div style="margin: 0.25rem 0;">${msg.message}</div>
        <div style="font-size: 0.8rem; opacity: 0.6;">${new Date(msg.timestamp).toLocaleTimeString()}</div>
      `;
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addSystemMessage(message) {
      const chat = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.style.borderLeftColor = '#4fc3f7';
      div.style.textAlign = 'center';
      div.style.fontStyle = 'italic';
      div.innerHTML = `<div style="opacity: 0.8;">${message}</div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function updateUserList() {
      const list = document.getElementById('userList');
      list.innerHTML = '';
      
      roomUsers.forEach(user => {
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
          <div class="user-info">
            <div class="user-color" style="background: ${user.color}"></div>
            <span>${user.username.slice(0, 15)}${user.username.length > 15 ? '...' : ''}</span>
            ${user.role === 'host' ? 'üëë' : user.role === 'moderator' ? '‚≠ê' : ''}
          </div>
          <div class="permissions-grid" data-userid="${user.userId}">
            <button class="permission-btn" onclick="togglePermission('${user.userId}', 'canControl')">–ú—ã—à—å</button>
            <button class="permission-btn" onclick="togglePermission('${user.userId}', 'canDraw')">–î–æ—Å–∫–∞</button>
          </div>
        `;
        list.appendChild(item);
      });
      
      document.getElementById('totalUsers').textContent = `(${roomUsers.length})`;
    }

    // Event Listeners
    function setupEventListeners() {
      window.addEventListener('resize', resizeCanvases);
      
      // Canvas —Å–æ–±—ã—Ç–∏—è
      screenCanvas.addEventListener('click', handleMouseClick);
      screenCanvas.addEventListener('mousedown', handleMouseDown);
      screenCanvas.addEventListener('mousemove', handleMouseMove);
      
      // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);
      
      // –ß–∞—Ç
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });
      
      // –°–ª–∞–π–¥–µ—Ä—ã
      document.getElementById('qualitySlider').addEventListener('input', updateQualityDisplay);
      document.getElementById('fpsSlider').addEventListener('input', updateFpsDisplay);
      
      // –§–∞–π–ª—ã
      document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    }

    function resizeCanvases() {
      const rect = screenCanvas.getBoundingClientRect();
      [screenCanvas, cursorCanvas, overlayCanvas, whiteboardCanvas].forEach(canvas => {
        canvas.width = rect.width;
        canvas.height = rect.height;
      });
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–º—ã—à—å, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –∑—É–º –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
    // –Ω–æ —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏ –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...

    // –ó–¥–µ—Å—å —Å–æ–∫—Ä–∞—â–∞—é –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
    function handleMouseMove(e) {
      if (!state.roomId || !document.getElementById('mouseControl').checked) return;
      
      const rect = screenCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      socket.emit('mouse-event', {
        roomId: state.roomId,
        type: 'mousemove',
        x, y,
        button: 'none'
      });
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ —Ç.–¥.
    function setupAuthTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab + 'Form').classList.add('active');
        });
      });
    }

    function loadPublicRooms() {
      socket.emit('get-rooms');
      document.getElementById('publicRooms').style.display = 'block';
    }

    function displayPublicRooms(rooms) {
      const grid = document.getElementById('roomsGrid');
      grid.innerHTML = '';
      
      rooms.forEach(room => {
        const card = document.createElement('div');
        card.className = 'room-card';
        card.onclick = () => {
          document.getElementById('roomIdInput').value = room.id;
          document.getElementById('mainMenu').style.display = 'none';
          document.getElementById('app').style.display = 'flex';
          joinRoom();
        };
        card.innerHTML = `
          <div class="room-title">${room.id}</div>
          <div class="room-stats">
            <span>üë• ${room.users}/${room.maxUsers}</span>
            <span>${room.screenActive ? 'üì∫ –ê–∫—Ç–∏–≤–Ω–æ' : '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</span>
          </div>
          <div style="margin-top: 1rem; opacity: 0.7;">–•–æ—Å—Ç: ${room.hostId}</div>
        `;
        grid.appendChild(card);
      });
    }

    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è
    function changeZoom(delta) { /* ... */ }
    function toggleCursorLock() { /* ... */ }
    function toggleWhiteboard() { /* ... */ }
    function togglePermission(userId, permission) { /* ... */ }
    function handleFileUpload() { /* ... */ }
    function updateQualityDisplay() { /* ... */ }
    function updateFpsDisplay() { /* ... */ }

    console.log('üöÄ Ultimate ScreenShare PRO v3.5 –∑–∞–≥—Ä—É–∂–µ–Ω!');
  </script>
</body>
</html>
