<!DOCTYPE html>
<html>
<head>
  <title>ScreenShare</title>
  <meta name="viewport" content="width=device-width">
  <script src="/socket.io/socket.io.js" defer></script>
  <style>
    body { margin: 0; font-family: Arial; background: #111; color: white; }
    #app { display: flex; height: 100vh; }
    #screen { flex: 1; position: relative; background: #000; }
    #sidebar { width: 280px; background: #222; padding: 20px; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #cursorCanvas { pointer-events: none; }
    button { width: 100%; padding: 12px; margin: 8px 0; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
    button:hover { background: #218838; }
    button:disabled { background: #555; }
    input { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; background: #333; border: 1px solid #555; border-radius: 6px; color: white; }
    #status { padding: 12px; background: #444; border-radius: 6px; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <div id="app">
    <div id="screen">
      <canvas id="screenCanvas"></canvas>
      <canvas id="cursorCanvas"></canvas>
    </div>
    <div id="sidebar">
      <div id="status">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
      <input id="roomId" value="demo" placeholder="–ö–æ–º–Ω–∞—Ç–∞">
      <button onclick="joinRoom()">üöÄ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
      <button onclick="startScreenShare()" id="shareBtn" disabled>üì∫ –¢—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Ä–∞–Ω</button>
      <div id="info">üë• 0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
    </div>
  </div>

  <script>
    const socket = io();
    const screenCanvas = document.getElementById('screenCanvas');
    const cursorCanvas = document.getElementById('cursorCanvas');
    const ctxScreen = screenCanvas.getContext('2d');
    const ctxCursor = cursorCanvas.getContext('2d');
    
    let roomId = 'demo';
    let screenStream = null;
    let isSharing = false;

    // –†–∞–∑–º–µ—Ä canvas
    function resize() {
      const rect = screenCanvas.getBoundingClientRect();
      screenCanvas.width = rect.width;
      screenCanvas.height = rect.height;
      cursorCanvas.width = rect.width;
      cursorCanvas.height = rect.height;
    }
    window.addEventListener('resize', resize);
    resize();

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
    function joinRoom() {
      roomId = document.getElementById('roomId').value;
      socket.emit('join-room', roomId);
      document.getElementById('status').textContent = `‚è≥ ${roomId}...`;
    }

    // –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (–ü–†–Ø–ú–û –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–ï–¢)
    async function startScreenShare() {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ 
          video: { width: 1920, height: 1080 },
          audio: true 
        });
        
        const video = document.createElement('video');
        video.srcObject = screenStream;
        video.play();
        
        isSharing = true;
        document.getElementById('shareBtn').textContent = 'üõë –°—Ç–æ–ø';
        document.getElementById('status').textContent = 'üì∫ –¢–†–ê–ù–°–õ–Ø–¶–ò–Ø –ê–ö–¢–ò–í–ù–ê';
        
        // –ö–ê–ñ–î–´–ô –ö–ê–î–† ‚Üí Socket
        function sendFrame() {
          ctxScreen.drawImage(video, 0, 0, screenCanvas.width, screenCanvas.height);
          const imageData = screenCanvas.toDataURL('image/jpeg', 0.7);
          socket.emit('screen-data', { roomId, imageData });
          if (isSharing) requestAnimationFrame(sendFrame);
        }
        sendFrame();
        
      } catch(err) {
        alert('–†–∞–∑—Ä–µ—à–∏ –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞!');
      }
    }

    // –ö–õ–ò–ö–ò –†–ê–ë–û–¢–ê–Æ–¢ –ù–ê –í–°–ï–• –£–°–¢–†–û–ô–°–¢–í–ê–•
    screenCanvas.addEventListener('click', (e) => {
      const rect = screenCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      
      socket.emit('mouse-event', { roomId, type: 'click', x, y });
      
      // –õ–æ–∫–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
      ctxScreen.fillStyle = 'rgba(255,255,0,0.6)';
      ctxScreen.beginPath();
      ctxScreen.arc(e.clientX - rect.left, e.clientY - rect.top, 20, 0, Math.PI*2);
      ctxScreen.fill();
    });

    // Socket —Å–æ–±—ã—Ç–∏—è
    socket.on('connect', () => {
      document.getElementById('status').textContent = '‚úÖ –û–ù–õ–ê–ô–ù';
      document.getElementById('shareBtn').disabled = false;
    });

    socket.on('user-joined', (data) => {
      document.getElementById('info').textContent = `üë• ${data.users} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
    });

    // –ü–û–õ–£–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–ê
    socket.on('screen-data', (data) => {
      if (data.roomId === roomId) {
        const img = new Image();
        img.onload = () => ctxScreen.drawImage(img, 0, 0, screenCanvas.width, screenCanvas.height);
        img.src = data.imageData;
      }
    });

    // –ü–û–õ–£–ß–ï–ù–ò–ï –ö–õ–ò–ö–û–í
    socket.on('mouse-event', (data) => {
      if (data.roomId === roomId) {
        const rect = screenCanvas.getBoundingClientRect();
        const x = data.x * rect.width;
        const y = data.y * rect.height;
        
        ctxScreen.fillStyle = 'rgba(0,255,0,0.6)';
        ctxScreen.beginPath();
        ctxScreen.arc(x, y, 25, 0, Math.PI*2);
        ctxScreen.fill();
      }
    });
  </script>
</body>
</html>
