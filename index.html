<!DOCTYPE html>
<html>
<head>
  <title>ScreenShare Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { margin: 0; font-family: Arial; background: #222; color: white; }
    #container { display: flex; height: 100vh; }
    #screen { flex: 1; position: relative; background: #000; }
    #sidebar { width: 300px; background: #333; padding: 20px; }
    #screenCanvas, #cursorCanvas { position: absolute; top: 0; left: 0; }
    button { width: 100%; padding: 12px; margin: 5px 0; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #666; cursor: not-allowed; }
    input { width: 100%; padding: 12px; margin: 5px 0; box-sizing: border-box; border: 1px solid #555; border-radius: 5px; background: #444; color: white; }
    #status { padding: 10px; background: #444; border-radius: 5px; margin: 10px 0; text-align: center; }
    .host-mode { border: 2px solid #00ff00; }
    .viewer-mode { border: 2px solid #ffaa00; }
  </style>
</head>
<body>
  <div id="container">
    <div id="screen">
      <canvas id="screenCanvas"></canvas>
      <canvas id="cursorCanvas"></canvas>
    </div>
    <div id="sidebar">
      <div id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
      <input id="roomId" value="room1" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
      <button onclick="startHost()">üñ•Ô∏è –°—Ç–∞—Ç—å –•–æ—Å—Ç–æ–º</button>
      <button onclick="joinViewer()" id="joinBtn" disabled>üëÅÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫–∞–∫ –∑—Ä–∏—Ç–µ–ª—å</button>
      <hr>
      <div>üë• –ó—Ä–∏—Ç–µ–ª–µ–π: <span id="viewerCount">0</span></div>
      <button onclick="captureScreen()" id="captureBtn" disabled>üì∏ –û–±–Ω–æ–≤–∏—Ç—å —ç–∫—Ä–∞–Ω</button>
    </div>
  </div>

  <script>
    const socket = io();
    const screenCanvas = document.getElementById('screenCanvas');
    const cursorCanvas = document.getElementById('cursorCanvas');
    const ctxScreen = screenCanvas.getContext('2d');
    const ctxCursor = cursorCanvas.getContext('2d');
    
    let isHost = false;
    let roomId = '';
    let viewers = 0;

    // –ê–¥–∞–ø—Ç–∞—Ü–∏—è canvas
    function resizeCanvas() {
      const rect = screenCanvas.getBoundingClientRect();
      screenCanvas.width = rect.width;
      screenCanvas.height = rect.height;
      cursorCanvas.width = rect.width;
      cursorCanvas.height = rect.height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // –†–µ–∂–∏–º –•–û–°–¢–ê
    function startHost() {
      roomId = document.getElementById('roomId').value;
      socket.emit('register-host', roomId);
      isHost = true;
      document.getElementById('status').innerHTML = `üñ•Ô∏è –•–û–°–¢: <strong>${roomId}</strong>`;
      document.getElementById('joinBtn').disabled = true;
      document.getElementById('captureBtn').disabled = false;
      screenCanvas.parentElement.classList.add('host-mode');
    }

    // –†–µ–∂–∏–º –ó–†–ò–¢–ï–õ–Ø
    function joinViewer() {
      roomId = document.getElementById('roomId').value;
      socket.emit('join-viewer', roomId);
      document.getElementById('status').innerHTML = `üëÅÔ∏è –ó–†–ò–¢–ï–õ–¨: <strong>${roomId}</strong>`;
      document.getElementById('captureBtn').style.display = 'none';
      screenCanvas.parentElement.classList.add('viewer-mode');
    }

    // –ó–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞ (—Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç)
    async function captureScreen() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          ctxScreen.drawImage(video, 0, 0, screenCanvas.width, screenCanvas.height);
          socket.emit('screen-frame', { 
            roomId, 
            image: screenCanvas.toDataURL('image/jpeg', 0.8) 
          });
          
          // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–¥—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 100–º—Å
          const interval = setInterval(() => {
            ctxScreen.drawImage(video, 0, 0, screenCanvas.width, screenCanvas.height);
            socket.emit('screen-frame', { 
              roomId, 
              image: screenCanvas.toDataURL('image/jpeg', 0.8) 
            });
          }, 100);
          
          stream.getTracks().forEach(track => track.onended = () => clearInterval(interval));
        };
      } catch(err) {
        alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –∑–∞—Ö–≤–∞—Ç —ç–∫—Ä–∞–Ω–∞');
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –∑—Ä–∏—Ç–µ–ª–µ–π (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
    function sendControl(type, x, y) {
      const rect = screenCanvas.getBoundingClientRect();
      socket.emit('viewer-control', {
        roomId,
        type,
        x: (x / rect.width),
        y: (y / rect.height)
      });
    }

    // –°–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    screenCanvas.addEventListener('click', (e) => {
      const rect = screenCanvas.getBoundingClientRect();
      sendControl('click', e.clientX - rect.left, e.clientY - rect.top);
    });

    screenCanvas.addEventListener('mousemove', (e) => {
      const rect = screenCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // –ö—É—Ä—Å–æ—Ä
      ctxCursor.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);
      ctxCursor.fillStyle = isHost ? '#00ff00' : '#ff0000';
      ctxCursor.beginPath();
      ctxCursor.arc(x, y, 8, 0, Math.PI*2);
      ctxCursor.fill();
    });

    // Socket —Å–æ–±—ã—Ç–∏—è
    socket.on('viewer-joined', (viewerId) => {
      viewers++;
      document.getElementById('viewerCount').textContent = viewers;
      document.getElementById('status').innerHTML += ` üëÅÔ∏è ${viewerId.slice(-4)}`;
    });

    socket.on('screen-frame', (data) => {
      const img = new Image();
      img.onload = () => ctxScreen.drawImage(img, 0, 0, screenCanvas.width, screenCanvas.height);
      img.src = data.image;
    });

    socket.on('execute-control', (data) => {
      // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–ª–∏–∫–∞ –Ω–∞ —Ö–æ—Å—Ç–µ
      const x = data.x * screenCanvas.width;
      const y = data.y * screenCanvas.height;
      
      ctxScreen.fillStyle = 'rgba(255,255,0,0.4)';
      ctxScreen.beginPath();
      ctxCursor.arc(x, y, 15, 0, Math.PI*2);
      ctxScreen.fill();
    });

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    socket.on('connect', () => {
      document.getElementById('status').textContent = '‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω';
      document.getElementById('joinBtn').disabled = false;
    });
  </script>
</body>
</html>
