<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate ScreenShare Control Pro</title>
  <script src="/socket.io/socket.io.js" defer></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
      position: relative;
    }

    #screen-container {
      flex: 1;
      position: relative;
      background: #000;
      overflow: hidden;
    }

    #screen-canvas, #cursor-canvas, #overlay-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: none;
    }

    #cursor-canvas {
      pointer-events: none;
      z-index: 20;
    }

    #overlay-canvas {
      pointer-events: none;
      z-index: 15;
    }

    #sidebar {
      width: 380px;
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .section {
      margin: 20px;
      padding: 20px;
      background: rgba(40, 40, 60, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #4fc3f7;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      width: 100%;
      padding: 14px 20px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4fc3f7, #29b6f6);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(79, 195, 247, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #66bb6a, #4caf50);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef5350, #f44336);
      color: white;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .input-group {
      margin: 12px 0;
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: white;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #4fc3f7;
      box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.1);
    }

    .slider-container {
      margin: 15px 0;
    }

    .slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    outline: none;
    appearance: none;           /* ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç */
    -webkit-appearance: none;   /* ‚úÖ WebKit (Chrome/Safari) */
    -moz-appearance: none;      /* ‚úÖ Firefox */
    border: none;
    cursor: pointer;
}

/* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–∞ –¥–ª—è –í–°–ï–• –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
.slider::-webkit-slider-thumb {
    -webkit-appearance: none;  /* ‚úÖ –¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ */
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4fc3f7, #29b6f6);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.4);
    transition: transform 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4fc3f7, #29b6f6);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(79, 195, 247, 0.4);
}

.slider::-ms-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4fc3f7, #29b6f6);
    cursor: pointer;
    border: none;
}


    .chat-messages {
      height: 250px;
      overflow-y: auto;
      background: rgba(20, 20, 40, 0.5);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-message {
      margin: 8px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border-left: 3px solid;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .user-list {
      max-height: 150px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      margin: 4px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 14px;
    }

    .user-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
    }

    .stat-item {
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .control-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      z-index: 25;
      min-width: 200px;
    }

    .zoom-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      #sidebar { width: 100%; height: 40%; }
      #screen-container { height: 60vh; }
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 30;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid #4fc3f7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- –≠–ö–†–ê–ù -->
    <div id="screen-container">
      <canvas id="screen-canvas"></canvas>
      <canvas id="cursor-canvas"></canvas>
      <canvas id="overlay-canvas"></canvas>
      
      <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
      <div class="control-panel" id="controlPanel">
        <div style="font-weight: 600; margin-bottom: 10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <div class="zoom-controls">
          <button class="btn btn-secondary" onclick="changeZoom(-0.1)">üîç</button>
          <span id="zoomLevel">100%</span>
          <button class="btn btn-secondary" onclick="changeZoom(0.1)">üîé</button>
        </div>
        <button class="btn btn-secondary" onclick="toggleCursorLock()" style="margin-top: 10px;">
          üñ±Ô∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫—É—Ä—Å–æ—Ä–∞
        </button>
      </div>

      <div class="loading" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
        <div style="margin-top: 10px; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Ä–∞–Ω–∞...</div>
      </div>
    </div>

    <!-- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div id="sidebar">
      <!-- –°–¢–ê–¢–£–° -->
      <div class="section">
        <div class="section-title">üì° –°—Ç–∞—Ç—É—Å</div>
        <div id="statusBar" class="status-bar">
          ‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            üë• <span id="userCount">0</span>
          </div>
          <div class="stat-item">
            üñ•Ô∏è <span id="fpsCounter">0</span> FPS
          </div>
        </div>
      </div>

      <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï -->
      <div class="section">
        <div class="section-title">üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
        <div class="input-group">
          <input type="text" class="input-field" id="roomId" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" maxlength="20">
        </div>
        <button class="btn btn-primary" onclick="joinRoom()">
          üöÄ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
        </button>
        <button class="btn btn-success" onclick="startScreenShare()" id="shareButton" disabled>
          üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é
        </button>
        <button class="btn btn-danger" onclick="leaveRoom()" id="leaveButton" style="display: none;">
          üö™ –í—ã–π—Ç–∏
        </button>
      </div>

      <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
      <div class="section">
        <div class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="slider-container">
          <label>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ: <span id="qualityValue">60%</span></label>
          <input type="range" class="slider" id="qualitySlider" min="0.1" max="1.0" step="0.1" value="0.6">
        </div>
        <div class="slider-container">
          <label>FPS: <span id="fpsValue">30</span></label>
          <input type="range" class="slider" id="fpsSlider" min="10" max="60" value="30">
        </div>
        <label style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
          <input type="checkbox" id="showCursors" checked> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫—É—Ä—Å–æ—Ä—ã
        </label>
        <label style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
          <input type="checkbox" id="mouseControl" checked> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—ã—à—å—é
        </label>
      </div>

      <!-- –ß–ê–¢ -->
      <div class="section">
        <div class="section-title">üí¨ –ß–∞—Ç</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div style="display: flex; gap: 10px;">
          <input type="text" class="input-field" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
          <button class="btn btn-secondary" onclick="sendChatMessage()" style="width: auto; padding: 14px 20px;">üì§</button>
        </div>
      </div>

      <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
      <div class="section">
        <div class="section-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div class="user-list" id="userList"></div>
      </div>
    </div>
  </div>

  <script>
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    const socket = io();
    const screenCanvas = document.getElementById('screen-canvas');
    const cursorCanvas = document.getElementById('cursor-canvas');
    const overlayCanvas = document.getElementById('overlay-canvas');
    
    const ctxScreen = screenCanvas.getContext('2d');
    const ctxCursor = cursorCanvas.getContext('2d');
    const ctxOverlay = overlayCanvas.getContext('2d');
    
    let state = {
      roomId: '',
      isHost: false,
      isConnected: false,
      screenSharing: false,
      zoomLevel: 1.0,
      cursorLocked: false,
      users: [],
      quality: 0.6,
      fps: 30,
      frameCount: 0,
      lastFpsTime: 0,
      screenStream: null,
      videoElement: null
    };

    let cursors = new Map();
    let chatHistory = [];
    let pendingFrames = 0;

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    function init() {
      resizeCanvases();
      setupEventListeners();
      updateStatus('üü¢ –ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤');
      requestAnimationFrame(gameLoop);
    }

    // –†–ï–ê–ô–ó –•–û–õ–°–¢–û–í
    function resizeCanvases() {
      const rect = screenCanvas.getBoundingClientRect();
      [screenCanvas, cursorCanvas, overlayCanvas].forEach(canvas => {
        canvas.width = rect.width;
        canvas.height = rect.height;
      });
    }

    // –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    function gameLoop(timestamp) {
      updateFPS(timestamp);
      updateCursors();
      renderOverlay();
      if (state.screenSharing) sendScreenFrame();
      
      requestAnimationFrame(gameLoop);
    }

    // FPS –°–ß–Å–¢–ß–ò–ö
    function updateFPS(timestamp) {
      state.frameCount++;
      if (timestamp - state.lastFpsTime >= 1000) {
        document.getElementById('fpsCounter').textContent = state.frameCount;
        state.frameCount = 0;
        state.lastFpsTime = timestamp;
      }
    }

    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–£–†–°–û–†–û–í
    function updateCursors() {
      ctxCursor.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);
      
      if (!document.getElementById('showCursors').checked) return;
      
      cursors.forEach(({ x, y, color, userId, size = 12 }, id) => {
        // –û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Ä—Å–æ—Ä
        ctxCursor.fillStyle = color;
        ctxCursor.beginPath();
        ctxCursor.arc(x, y, size, 0, Math.PI * 2);
        ctxCursor.fill();
        
        // –û–±–≤–æ–¥–∫–∞
        ctxCursor.strokeStyle = 'rgba(255, 255, 255, 0.8)';
        ctxCursor.lineWidth = 2;
        ctxCursor.stroke();
        
        // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ctxCursor.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctxCursor.fillRect(x - 30, y - 25, 60, 20);
        ctxCursor.fillStyle = 'white';
        ctxCursor.font = 'bold 11px Arial';
        ctxCursor.textAlign = 'center';
        ctxCursor.textBaseline = 'middle';
        ctxCursor.fillText(userId.slice(-4), x, y - 15);
      });
    }

    // –†–ï–ù–î–ï–† –û–í–ï–†–õ–ï–Ø
    function renderOverlay() {
      ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      
      // –°–µ—Ç–∫–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
      if (state.zoomLevel > 1.2) {
        ctxOverlay.strokeStyle = 'rgba(0, 255, 255, 0.1)';
        ctxOverlay.lineWidth = 1;
        for (let i = 0; i < overlayCanvas.width; i += 50) {
          ctxOverlay.beginPath();
          ctxOverlay.moveTo(i, 0);
          ctxOverlay.lineTo(i, overlayCanvas.height);
          ctxOverlay.stroke();
        }
        for (let i = 0; i < overlayCanvas.height; i += 50) {
          ctxOverlay.beginPath();
          ctxOverlay.moveTo(0, i);
          ctxOverlay.lineTo(overlayCanvas.width, i);
          ctxOverlay.stroke();
        }
      }
    }

    // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ö–û–ú–ù–ê–¢–ï
    function joinRoom() {
      state.roomId = document.getElementById('roomId').value.trim();
      if (!state.roomId) {
        showError('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }

      updateStatus(`üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${state.roomId}...`);
      socket.emit('join-room', { roomId: state.roomId });
      document.getElementById('leaveButton').style.display = 'block';
      document.getElementById('shareButton').disabled = false;
    }

    // –ù–ê–ß–ê–õ–û –¢–†–ê–ù–°–õ–Ø–¶–ò–ò –≠–ö–†–ê–ù–ê
    async function startScreenShare() {
      try {
        if (state.screenSharing) {
          // –û–°–¢–ê–ù–û–í–ö–ê –¢–†–ê–ù–°–õ–Ø–¶–ò–ò
          if (state.screenStream) {
            state.screenStream.getTracks().forEach(track => track.stop());
          }
          state.screenSharing = false;
          document.getElementById('shareButton').textContent = 'üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
          document.getElementById('statusBar').innerHTML = '‚èπÔ∏è –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
          return;
        }

        // –ó–ê–ü–£–°–ö –¢–†–ê–ù–°–õ–Ø–¶–ò–ò
        state.screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { 
            width: { ideal: 1920 }, 
            height: { ideal: 1080 },
            frameRate: { ideal: state.fps }
          },
          audio: true
        });

        state.videoElement = document.createElement('video');
        state.videoElement.srcObject = state.screenStream;
        state.videoElement.play();

        state.screenSharing = true;
        document.getElementById('shareButton').textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
        updateStatus('üì∫ –¢–†–ê–ù–°–õ–Ø–¶–ò–Ø –ê–ö–¢–ò–í–ù–ê');

        // –û–¢–ü–†–ê–í–ö–ê –ö–ê–î–†–û–í
        function sendFrame() {
          if (!state.screenSharing || !state.videoElement) return;
          
          ctxScreen.drawImage(state.videoElement, 0, 0, screenCanvas.width, screenCanvas.height);
          
          const quality = parseFloat(document.getElementById('qualitySlider').value);
          const imageData = screenCanvas.toDataURL('image/jpeg', quality);
          
          socket.emit('screen-frame', {
            roomId: state.roomId,
            imageData,
            settings: {
              quality,
              fps: state.fps,
              timestamp: Date.now()
            }
          });
          
          pendingFrames++;
          requestAnimationFrame(sendFrame);
        }
        sendFrame();

      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞: ' + error.message);
      }
    }

    // –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –í –ß–ê–¢
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message || !state.isConnected) return;

      socket.emit('chat-message', {
        roomId: state.roomId,
        message: message
      });
      input.value = '';
    }

    // –í–´–•–û–î –ò–ó –ö–û–ú–ù–ê–¢–´
    function leaveRoom() {
      socket.emit('leave-room', { roomId: state.roomId });
      state.roomId = '';
      state.isConnected = false;
      state.screenSharing = false;
      
      document.getElementById('statusBar').textContent = 'üö™ –í—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã';
      document.getElementById('leaveButton').style.display = 'none';
      document.getElementById('shareButton').disabled = true;
      document.getElementById('shareButton').textContent = 'üì∫ –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
      
      ctxScreen.clearRect(0, 0, screenCanvas.width, screenCanvas.height);
      cursors.clear();
      chatHistory = [];
    }

    // –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–£–ú–ê
    function changeZoom(delta) {
      state.zoomLevel = Math.max(0.3, Math.min(3.0, state.zoomLevel + delta));
      screenCanvas.style.transform = `scale(${state.zoomLevel})`;
      document.getElementById('zoomLevel').textContent = Math.round(state.zoomLevel * 100) + '%';
    }

    // –ë–õ–û–ö–ò–†–û–í–ö–ê –ö–£–†–°–û–†–ê
    function toggleCursorLock() {
      state.cursorLocked = !state.cursorLocked;
      document.getElementById('controlPanel').style.display = state.cursorLocked ? 'none' : 'block';
      
      if (state.cursorLocked) {
        document.body.requestPointerLock();
      } else {
        document.exitPointerLock();
      }
    }

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    function setupEventListeners() {
      // –†–ï–ê–ô–ó
      window.addEventListener('resize', resizeCanvases);

      // –ö–õ–ò–ö–ò
      screenCanvas.addEventListener('click', handleMouseClick);
      screenCanvas.addEventListener('mousedown', handleMouseDown);
      screenCanvas.addEventListener('mousemove', handleMouseMove);

      // –ö–õ–ê–í–ò–ê–¢–£–†–ê
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      // –ß–ê–¢ (ENTER)
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
      });

      // –°–õ–ê–ô–î–ï–†–´
      document.getElementById('qualitySlider').addEventListener('input', (e) => {
        document.getElementById('qualityValue').textContent = Math.round(e.target.value * 100) + '%';
        state.quality = parseFloat(e.target.value);
      });

      document.getElementById('fpsSlider').addEventListener('input', (e) => {
        document.getElementById('fpsValue').textContent = e.target.value;
        state.fps = parseInt(e.target.value);
      });

      // –ß–ï–ö–ë–û–ö–°–´
      document.getElementById('showCursors').addEventListener('change', (e) => {
        socket.emit('room-settings', {
          roomId: state.roomId,
          settings: { showCursors: e.target.checked }
        });
      });
    }

    // –ú–û–£–° –î–í–ò–ñ–ï–ù–ò–ï
    function handleMouseMove(e) {
      if (!state.isConnected || !state.roomId) return;

      const rect = screenCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      cursors.set('local', {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top,
        color: '#ffffff',
        userId: 'YOU'
      });

      socket.emit('mouse-event', {
        roomId: state.roomId,
        type: 'mousemove',
        x, y,
        button: 'none'
      });
    }

    // –ö–õ–ò–ö
    function handleMouseClick(e) {
      if (!document.getElementById('mouseControl').checked) return;

      const rect = screenCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;

      socket.emit('mouse-event', {
        roomId: state.roomId,
        type: 'click',
        x, y,
        button: 'left'
      });

      // –í–ò–ó–£–ê–õ–¨–ù–´–ô –≠–§–§–ï–ö–¢
      ctxOverlay.fillStyle = 'rgba(255, 255, 0, 0.8)';
      ctxOverlay.beginPath();
      ctxOverlay.arc(e.clientX - rect.left, e.clientY - rect.top, 25, 0, Math.PI * 2);
      ctxOverlay.fill();
    }

    function handleMouseDown(e) {
      socket.emit('mouse-event', {
        roomId: state.roomId,
        type: 'mousedown',
        x: 0, y: 0,
        button: e.button === 0 ? 'left' : e.button === 2 ? 'right' : 'middle'
      });
    }

    function handleKeyDown(e) {
      socket.emit('keyboard-event', {
        roomId: state.roomId,
        type: 'keydown',
        key: e.key,
        code: e.code
      });
    }

    function handleKeyUp(e) {
      socket.emit('keyboard-event', {
        roomId: state.roomId,
        type: 'keyup',
        key: e.key,
        code: e.code
      });
    }

    // SOCKET –°–û–ë–´–¢–ò–Ø
    socket.on('connect', () => {
      state.isConnected = true;
      updateStatus('üü¢ –ü–û–î–ö–õ–Æ–ß–ï–ù –ö –°–ï–†–í–ï–†–£');
    });

    socket.on('disconnect', () => {
      state.isConnected = false;
      updateStatus('üî¥ –û–¢–ö–õ–Æ–ß–ï–ù –û–¢ –°–ï–†–í–ï–†–ê');
    });

    socket.on('room-joined', (data) => {
      state.isHost = data.room.hostId === socket.id;
      updateStatus(`‚úÖ –í –ö–û–ú–ù–ê–¢–ï ${state.roomId} (${data.room.users.size} —á–µ–ª.)`);
      document.getElementById('userCount').textContent = data.room.users.size;
    });

    socket.on('user-joined', (data) => {
      cursors.set(data.userId, {
        x: Math.random() * screenCanvas.width,
        y: Math.random() * screenCanvas.height,
        color: data.color,
        userId: data.userId.slice(-4)
      });
      document.getElementById('userCount').textContent = parseInt(document.getElementById('userCount').textContent) + 1;
    });

    socket.on('user-left', (data) => {
      cursors.delete(data.userId);
      document.getElementById('userCount').textContent = parseInt(document.getElementById('userCount').textContent) - 1;
    });

    socket.on('screen-frame', (data) => {
      pendingFrames--;
      document.getElementById('loadingSpinner').style.display = 'none';
      
      const img = new Image();
      img.onload = () => {
        ctxScreen.drawImage(img, 0, 0, screenCanvas.width, screenCanvas.height);
      };
      img.src = data.imageData;
    });

    socket.on('mouse-event', (data) => {
      if (!data.userId || data.userId === socket.id) return;

      cursors.set(data.userId, {
        x: data.x * screenCanvas.width,
        y: data.y * screenCanvas.height,
        color: data.color,
        userId: data.userId.slice(-4)
      });

      // –≠–§–§–ï–ö–¢ –ö–õ–ò–ö–ê
      if (data.type === 'click') {
        ctxOverlay.fillStyle = `rgba(${parseInt(data.color.slice(1,3),16)},${parseInt(data.color.slice(3,5),16)},${parseInt(data.color.slice(5,7),16)},0.6)`;
        ctxOverlay.beginPath();
        ctxOverlay.arc(data.x * screenCanvas.width, data.y * screenCanvas.height, 30, 0, Math.PI * 2);
        ctxOverlay.fill();
      }
    });

    socket.on('chat-message', (data) => {
      addChatMessage(data);
    });

    socket.on('room-settings-updated', (settings) => {
      document.getElementById('qualitySlider').value = settings.quality || 0.6;
      document.getElementById('fpsSlider').value = settings.fps || 30;
      document.getElementById('showCursors').checked = settings.showCursors !== false;
    });

    socket.on('error', (data) => {
      showError(data.message);
    });

    // –£–¢–ò–õ–ò–¢–´
    function updateStatus(message) {
      document.getElementById('statusBar').innerHTML = message;
    }

    function showError(message) {
      const oldStatus = document.getElementById('statusBar').textContent;
      document.getElementById('statusBar').innerHTML = `‚ùå ${message}`;
      setTimeout(() => {
        document.getElementById('statusBar').textContent = oldStatus;
      }, 3000);
    }

    function addChatMessage(msg) {
      chatHistory.push(msg);
      if (chatHistory.length > 50) chatHistory.shift();

      const chat = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message';
      div.style.borderLeftColor = msg.color;
      div.innerHTML = `
        <div style="font-weight: 600; color: ${msg.color};">${msg.userId.slice(-4)}</div>
        <div>${msg.message}</div>
        <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">${new Date(msg.timestamp).toLocaleTimeString()}</div>
      `;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    // –ó–ê–ü–£–°–ö
    window.addEventListener('load', init);
  </script>
</body>
</html>
